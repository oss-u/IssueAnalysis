[
  {
    "url": "https://api.github.com/repos/jupyter/notebook/issues/comments/629611373",
    "html_url": "https://github.com/jupyter/notebook/pull/5450#issuecomment-629611373",
    "issue_url": "https://api.github.com/repos/jupyter/notebook/issues/5450",
    "id": 629611373,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTYxMTM3Mw==",
    "user": {
      "login": "blink1073",
      "id": 2096628,
      "node_id": "MDQ6VXNlcjIwOTY2Mjg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2096628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/blink1073",
      "html_url": "https://github.com/blink1073",
      "followers_url": "https://api.github.com/users/blink1073/followers",
      "following_url": "https://api.github.com/users/blink1073/following{/other_user}",
      "gists_url": "https://api.github.com/users/blink1073/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/blink1073/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/blink1073/subscriptions",
      "organizations_url": "https://api.github.com/users/blink1073/orgs",
      "repos_url": "https://api.github.com/users/blink1073/repos",
      "events_url": "https://api.github.com/users/blink1073/events{/privacy}",
      "received_events_url": "https://api.github.com/users/blink1073/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-16T08:47:57Z",
    "updated_at": "2020-05-16T08:47:57Z",
    "author_association": "MEMBER",
    "body": "Test failure looks legitimate: \r\n\r\n```\r\nFAIL \"function () {\r\n\r\n        return this.evaluate(function (events) {\r\n\r\n            return IPython._events_triggered.length >= events.length;\r\n\r\n        }, [events]);\r\n\r\n    }\" did not evaluate to something truthy in 10000ms\r\n\r\n#    type: uncaughtError\r\n\r\n#    file: /home/travis/build/jupyter/notebook/notebook/tests/services/kernel.js\r\n\r\n#    error: \"function () {\r\n\r\n        return this.evaluate(function (events) {\r\n\r\n            return IPython._events_triggered.length >= events.length;\r\n\r\n        }, [events]);\r\n\r\n    }\" did not evaluate to something truthy in 10000ms\r\n\r\n#    stack: not provided\r\n\r\nCaptured console.log:\r\n\r\n    Welcome to Project Jupyter! Explore the various tools available and their corresponding documentation. If you are interested in contributing to the platform, please visit the community resources section at http://jupyter.org/community.html.\r\n\r\n    Loaded moment locale en\r\n\r\n    actions jupyter-notebook:find-and-replace does not exist, still binding it in case it will be defined later...\r\n\r\n    Loaded moment locale en\r\n\r\n    Widgets are not available.  Please install widgetsnbextension or ipywidgets 4.0\r\n\r\n    Session: kernel_created (1e271404-e8d0-45b0-afd9-4efeea19cbb9)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/54407a5a-e1e2-46a9-9187-5bfbdaad77dc\r\n\r\n    Kernel: kernel_connected (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_ready (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_interrupting (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_restarting (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_created (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/54407a5a-e1e2-46a9-9187-5bfbdaad77dc\r\n\r\n    Kernel: kernel_connected (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_starting (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_ready (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_ready (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_reconnecting (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/54407a5a-e1e2-46a9-9187-5bfbdaad77dc\r\n\r\n    Kernel: kernel_connected (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_ready (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_killed (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_starting (54407a5a-e1e2-46a9-9187-5bfbdaad77dc)\r\n\r\n    Kernel: kernel_created (690611e1-1269-4ee4-b424-fb4bbda12c21)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/690611e1-1269-4ee4-b424-fb4bbda12c21\r\n\r\n    Kernel: kernel_connected (690611e1-1269-4ee4-b424-fb4bbda12c21)\r\n\r\n    Kernel: kernel_ready (690611e1-1269-4ee4-b424-fb4bbda12c21)\r\n\r\n    Kernel: kernel_killed (690611e1-1269-4ee4-b424-fb4bbda12c21)\r\n\r\n    Kernel: kernel_starting (690611e1-1269-4ee4-b424-fb4bbda12c21)\r\n\r\n    Kernel: kernel_created (96f841b7-29ff-49ad-bf40-e546e59ccb9e)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/96f841b7-29ff-49ad-bf40-e546e59ccb9e\r\n\r\n    Kernel: kernel_connected (96f841b7-29ff-49ad-bf40-e546e59ccb9e)\r\n\r\n    Kernel: kernel_ready (96f841b7-29ff-49ad-bf40-e546e59ccb9e)\r\n\r\n    Kernel: kernel_killed (96f841b7-29ff-49ad-bf40-e546e59ccb9e)\r\n\r\n    Kernel: kernel_starting (96f841b7-29ff-49ad-bf40-e546e59ccb9e)\r\n\r\n    Kernel: kernel_created (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341\r\n\r\n    Kernel: kernel_connected (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Kernel: kernel_ready (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Kernel: kernel_reconnecting (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341\r\n\r\n    Kernel: kernel_connected (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Kernel: kernel_ready (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Kernel: kernel_restarting (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Kernel: kernel_created (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341\r\n\r\n    Kernel: kernel_connected (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    WebSocket closed early Object {\r\n\r\n      \"code\": 1006,\r\n\r\n      \"reason\": \"\",\r\n\r\n      \"wasClean\": false,\r\n\r\n      \"returnValue\": true,\r\n\r\n      \"timeStamp\": 1589589147812,\r\n\r\n      \"eventPhase\": 2,\r\n\r\n      \"target\":\r\n\r\n        \"readyState\": 3,\r\n\r\n        \"bufferedAmount\": 0,\r\n\r\n        \"extensions\": \"\",\r\n\r\n        \"url\": \"ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341/channels?session_id=9f54db2268d34c779bac45be05294444\",\r\n\r\n        \"binaryType\": \"blob\",\r\n\r\n        \"protocol\": \"\",\r\n\r\n        \"URL\": \"ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341/channels?session_id=9f54db2268d34c779bac45be05294444\"\r\n\r\n      \"defaultPrevented\": false,\r\n\r\n      \"srcElement\":\r\n\r\n        \"readyState\": 3,\r\n\r\n        \"bufferedAmount\": 0,\r\n\r\n        \"extensions\": \"\",\r\n\r\n        \"url\": \"ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341/channels?session_id=9f54db2268d34c779bac45be05294444\",\r\n\r\n        \"binaryType\": \"blob\",\r\n\r\n        \"protocol\": \"\",\r\n\r\n        \"URL\": \"ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341/channels?session_id=9f54db2268d34c779bac45be05294444\"\r\n\r\n      \"type\": \"close\",\r\n\r\n      \"cancelable\": false,\r\n\r\n      \"currentTarget\":\r\n\r\n        \"readyState\": 3,\r\n\r\n        \"bufferedAmount\": 0,\r\n\r\n        \"extensions\": \"\",\r\n\r\n        \"url\": \"ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341/channels?session_id=9f54db2268d34c779bac45be05294444\",\r\n\r\n        \"binaryType\": \"blob\",\r\n\r\n        \"protocol\": \"\",\r\n\r\n        \"URL\": \"ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341/channels?session_id=9f54db2268d34c779bac45be05294444\"\r\n\r\n      \"bubbles\": false,\r\n\r\n      \"cancelBubble\": false\r\n\r\n    }\r\n\r\n    Kernel: kernel_disconnected (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Connection lost, reconnecting in 1 seconds.\r\n\r\n    Kernel: kernel_reconnecting (5e3ca932-8c9b-4a89-bf61-a9f230a0b341)\r\n\r\n    Starting WebSockets: ws://localhost:8888/a@b/api/kernels/5e3ca932-8c9b-4a89-bf61-a9f230a0b341\r\n```",
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/jupyter/notebook/issues/comments/629658047",
    "html_url": "https://github.com/jupyter/notebook/pull/5450#issuecomment-629658047",
    "issue_url": "https://api.github.com/repos/jupyter/notebook/issues/5450",
    "id": 629658047,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTY1ODA0Nw==",
    "user": {
      "login": "kevin-bates",
      "id": 22599560,
      "node_id": "MDQ6VXNlcjIyNTk5NTYw",
      "avatar_url": "https://avatars.githubusercontent.com/u/22599560?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kevin-bates",
      "html_url": "https://github.com/kevin-bates",
      "followers_url": "https://api.github.com/users/kevin-bates/followers",
      "following_url": "https://api.github.com/users/kevin-bates/following{/other_user}",
      "gists_url": "https://api.github.com/users/kevin-bates/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kevin-bates/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kevin-bates/subscriptions",
      "organizations_url": "https://api.github.com/users/kevin-bates/orgs",
      "repos_url": "https://api.github.com/users/kevin-bates/repos",
      "events_url": "https://api.github.com/users/kevin-bates/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kevin-bates/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-16T14:51:37Z",
    "updated_at": "2020-05-16T14:51:37Z",
    "author_association": "MEMBER",
    "body": "I agree - this test failure looks legit and I should have noticed this yesterday (too anxious to get the weekend started).  Unfortunately, I have no clue how that particular test works.  I suspect these changes may introduce another \"event\" since a reconnect to the ports (via `create_stream()`) now occurs irrespective of session.  Are you able to determine if this is just a matter of updating a test that may be too tight or an indication of an incompatible change?\r\n\r\nTo be honest, these server changes aren't required for EG's remote kernels since a new session_key is introduced anyway (due to the way the kernel requests are proxied), which results in [`open()`](https://github.com/jupyter/notebook/pull/5450/files#diff-5850e3e642720fc64de3044370632daeL256) always calling `self.create_stream()` anyway.  As a result, the logic in this PR primarily addresses kernels spawned from the current server that recreate their ports on restarts - which, I suppose, can exist.\r\n\r\nI've verified that restarts from Lab with EG kernels now work with only the fix provided by @jasongrout  in https://github.com/jupyterlab/jupyterlab/pull/8432.  I also checked restarts with local kernels (that retain ports across restarts) still work using only the Lab change.  So, IMHO, this PR could probably be deferred to jupyter_server - where kernel providers will definitely introduce port changes on restarts.\r\n",
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/jupyter/notebook/issues/comments/629663734",
    "html_url": "https://github.com/jupyter/notebook/pull/5450#issuecomment-629663734",
    "issue_url": "https://api.github.com/repos/jupyter/notebook/issues/5450",
    "id": 629663734,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTY2MzczNA==",
    "user": {
      "login": "blink1073",
      "id": 2096628,
      "node_id": "MDQ6VXNlcjIwOTY2Mjg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2096628?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/blink1073",
      "html_url": "https://github.com/blink1073",
      "followers_url": "https://api.github.com/users/blink1073/followers",
      "following_url": "https://api.github.com/users/blink1073/following{/other_user}",
      "gists_url": "https://api.github.com/users/blink1073/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/blink1073/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/blink1073/subscriptions",
      "organizations_url": "https://api.github.com/users/blink1073/orgs",
      "repos_url": "https://api.github.com/users/blink1073/repos",
      "events_url": "https://api.github.com/users/blink1073/events{/privacy}",
      "received_events_url": "https://api.github.com/users/blink1073/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-16T15:31:13Z",
    "updated_at": "2020-05-16T15:31:13Z",
    "author_association": "MEMBER",
    "body": "I don't have the bandwidth to dive into this, I'd say defer it ",
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/jupyter/notebook/issues/comments/629666258",
    "html_url": "https://github.com/jupyter/notebook/pull/5450#issuecomment-629666258",
    "issue_url": "https://api.github.com/repos/jupyter/notebook/issues/5450",
    "id": 629666258,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTY2NjI1OA==",
    "user": {
      "login": "jasongrout",
      "id": 192614,
      "node_id": "MDQ6VXNlcjE5MjYxNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/192614?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jasongrout",
      "html_url": "https://github.com/jasongrout",
      "followers_url": "https://api.github.com/users/jasongrout/followers",
      "following_url": "https://api.github.com/users/jasongrout/following{/other_user}",
      "gists_url": "https://api.github.com/users/jasongrout/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jasongrout/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jasongrout/subscriptions",
      "organizations_url": "https://api.github.com/users/jasongrout/orgs",
      "repos_url": "https://api.github.com/users/jasongrout/repos",
      "events_url": "https://api.github.com/users/jasongrout/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jasongrout/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-16T15:50:05Z",
    "updated_at": "2020-05-16T15:50:05Z",
    "author_association": "MEMBER",
    "body": "Iirc, I needed this when I was I insisting that the ports change on restart by explicitly setting the port caching to false (see the original issue)",
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/jupyter/notebook/issues/comments/629684267",
    "html_url": "https://github.com/jupyter/notebook/pull/5450#issuecomment-629684267",
    "issue_url": "https://api.github.com/repos/jupyter/notebook/issues/5450",
    "id": 629684267,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTY4NDI2Nw==",
    "user": {
      "login": "kevin-bates",
      "id": 22599560,
      "node_id": "MDQ6VXNlcjIyNTk5NTYw",
      "avatar_url": "https://avatars.githubusercontent.com/u/22599560?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kevin-bates",
      "html_url": "https://github.com/kevin-bates",
      "followers_url": "https://api.github.com/users/kevin-bates/followers",
      "following_url": "https://api.github.com/users/kevin-bates/following{/other_user}",
      "gists_url": "https://api.github.com/users/kevin-bates/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kevin-bates/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kevin-bates/subscriptions",
      "organizations_url": "https://api.github.com/users/kevin-bates/orgs",
      "repos_url": "https://api.github.com/users/kevin-bates/repos",
      "events_url": "https://api.github.com/users/kevin-bates/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kevin-bates/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-16T17:59:17Z",
    "updated_at": "2020-05-16T17:59:17Z",
    "author_association": "MEMBER",
    "body": "Thank you for the responses and clarification (Jason).  Since this runs a non-zero chance of destabilizing behaviors due to the assumption that ports are static across restarts, I'm in favor of closing this PR and addressing this in jupyter_server - where the wiggle room for changes like this is a bit wider.",
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/jupyter/notebook/issues/comments/629836248",
    "html_url": "https://github.com/jupyter/notebook/pull/5450#issuecomment-629836248",
    "issue_url": "https://api.github.com/repos/jupyter/notebook/issues/5450",
    "id": 629836248,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyOTgzNjI0OA==",
    "user": {
      "login": "kevin-bates",
      "id": 22599560,
      "node_id": "MDQ6VXNlcjIyNTk5NTYw",
      "avatar_url": "https://avatars.githubusercontent.com/u/22599560?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kevin-bates",
      "html_url": "https://github.com/kevin-bates",
      "followers_url": "https://api.github.com/users/kevin-bates/followers",
      "following_url": "https://api.github.com/users/kevin-bates/following{/other_user}",
      "gists_url": "https://api.github.com/users/kevin-bates/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kevin-bates/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kevin-bates/subscriptions",
      "organizations_url": "https://api.github.com/users/kevin-bates/orgs",
      "repos_url": "https://api.github.com/users/kevin-bates/repos",
      "events_url": "https://api.github.com/users/kevin-bates/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kevin-bates/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-17T17:55:27Z",
    "updated_at": "2020-05-17T17:55:27Z",
    "author_association": "MEMBER",
    "body": "Spent a bit of time with this and see that restarts produce the following for local kernels via the Notebook UI:\r\n```\r\n[E 08:49:40.345 LabApp] Uncaught exception GET /api/kernels/ab29e63f-fcc9-4ad0-add0-d3d45aea7800/channels?session_id=d2da0011331244768b766f9a1c488c31 (127.0.0.1)\r\n    HTTPServerRequest(protocol='http', host='0.0.0.0:8888', method='GET', uri='/api/kernels/ab29e63f-fcc9-4ad0-add0-d3d45aea7800/channels?session_id=d2da0011331244768b766f9a1c488c31', version='HTTP/1.1', remote_ip='127.0.0.1')\r\n    Traceback (most recent call last):\r\n      File \"/opt/anaconda3/envs/notebook-dev/lib/python3.7/site-packages/tornado/websocket.py\", line 956, in _accept_connection\r\n        open_result = handler.open(*handler.open_args, **handler.open_kwargs)\r\n      File \"/Users/kbates/repos/oss/jupyter/notebook/notebook/services/kernels/handlers.py\", line 270, in open\r\n        self._on_zmq_reply(stream, msg_list)\r\n      File \"/Users/kbates/repos/oss/jupyter/notebook/notebook/services/kernels/handlers.py\", line 423, in _on_zmq_reply\r\n        super(ZMQChannelsHandler, self)._on_zmq_reply(stream, msg)\r\n      File \"/Users/kbates/repos/oss/jupyter/notebook/notebook/base/zmqhandlers.py\", line 242, in _on_zmq_reply\r\n        if self.ws_connection is None or stream.closed():\r\n    AttributeError: 'dict' object has no attribute 'closed'\r\n```\r\nThis does not happen using the Lab UI.  \r\n\r\nThe reason this works via the Notebook UI against an EG server is due to the lack of handling of the session key, which winds up skipping the replay logic where the issue occurs.  It also appears that buffer replay is slightly different via the Lab UI since there no messages get buffered when the Lab UI is used.  I suspect Notebook UI must be triggering a close() that Lab Ui doesn't - thereby triggering the buffering of the status messages across a restart.\r\n\r\nHere's the log sequence for a restart via Lab:\r\n```\r\n[D 09:06:32.823 LabApp] Accepting token-authenticated connection from 127.0.0.1\r\n[D 09:06:33.147 LabApp] Starting kernel: ['/opt/anaconda3/envs/notebook-dev/bin/python', '-m', 'ipykernel_launcher', '-f', '/Users/kbates/Library/Jupyter/runtime/kernel-04f76333-de41-40ab-b15b-76177a895328.json']\r\n[D 09:06:33.164 LabApp] Connecting to: tcp://127.0.0.1:57764\r\n[I 09:06:33.166 LabApp] Kernel restarted: 04f76333-de41-40ab-b15b-76177a895328\r\n[D 09:06:33.167 LabApp] Connecting to: tcp://127.0.0.1:57760\r\n[D 09:06:33.177 LabApp] 200 POST /api/kernels/04f76333-de41-40ab-b15b-76177a895328/restart?1589731592813 (127.0.0.1) 358.23ms\r\n[D 09:06:33.203 LabApp] activity on 04f76333-de41-40ab-b15b-76177a895328: status (busy)\r\n[D 09:06:33.227 LabApp] activity on 04f76333-de41-40ab-b15b-76177a895328: shutdown_reply\r\n[D 09:06:33.251 LabApp] activity on 04f76333-de41-40ab-b15b-76177a895328: status (idle)\r\n[D 09:06:33.253 LabApp] Websocket closed 04f76333-de41-40ab-b15b-76177a895328:b757a8b6-1bfa-4776-8462-bee15dc8601c\r\n[D 09:06:33.264 LabApp] Initializing websocket connection /api/kernels/04f76333-de41-40ab-b15b-76177a895328/channels\r\n```\r\nAnd that of restart via Notebook:\r\n```\r\n[D 09:09:59.479 LabApp] Websocket closed fc9693cd-f3a8-43fe-962d-b6222143c307:9325611663dd49f995fc3150124b5559\r\n[I 09:09:59.481 LabApp] Starting buffering for fc9693cd-f3a8-43fe-962d-b6222143c307:9325611663dd49f995fc3150124b5559\r\n[D 09:09:59.482 LabApp] Clearing buffer for fc9693cd-f3a8-43fe-962d-b6222143c307\r\n[D 09:09:59.817 LabApp] Starting kernel: ['/opt/anaconda3/envs/notebook-dev/bin/python', '-m', 'ipykernel_launcher', '-f', '/Users/kbates/Library/Jupyter/runtime/kernel-fc9693cd-f3a8-43fe-962d-b6222143c307.json']\r\n[D 09:09:59.828 LabApp] Connecting to: tcp://127.0.0.1:53672\r\n[I 09:09:59.830 LabApp] Kernel restarted: fc9693cd-f3a8-43fe-962d-b6222143c307\r\n[D 09:09:59.832 LabApp] Connecting to: tcp://127.0.0.1:53668\r\n[D 09:09:59.844 LabApp] 200 POST /api/kernels/fc9693cd-f3a8-43fe-962d-b6222143c307/restart (127.0.0.1) 354.31ms\r\n[D 09:09:59.853 LabApp] activity on fc9693cd-f3a8-43fe-962d-b6222143c307: status (busy)\r\n[D 09:09:59.855 LabApp] Buffering msg on fc9693cd-f3a8-43fe-962d-b6222143c307:iopub\r\n[D 09:09:59.865 LabApp] activity on fc9693cd-f3a8-43fe-962d-b6222143c307: shutdown_reply\r\n[D 09:09:59.866 LabApp] Buffering msg on fc9693cd-f3a8-43fe-962d-b6222143c307:iopub\r\n[D 09:09:59.877 LabApp] activity on fc9693cd-f3a8-43fe-962d-b6222143c307: status (idle)\r\n[D 09:09:59.878 LabApp] Buffering msg on fc9693cd-f3a8-43fe-962d-b6222143c307:iopub\r\n[D 09:09:59.885 LabApp] Initializing websocket connection /api/kernels/fc9693cd-f3a8-43fe-962d-b6222143c307/channels\r\n[I 09:09:59.902 LabApp] Adapting from protocol version 5.1 (kernel fc9693cd-f3a8-43fe-962d-b6222143c307) to 5.3 (client).\r\n[D 09:09:59.908 LabApp] 101 GET /api/kernels/fc9693cd-f3a8-43fe-962d-b6222143c307/channels?session_id=9325611663dd49f995fc3150124b5559 (127.0.0.1) 26.94ms\r\n[D 09:09:59.915 LabApp] Opening websocket /api/kernels/fc9693cd-f3a8-43fe-962d-b6222143c307/channels\r\n[D 09:10:03.267 LabApp] Getting buffer for fc9693cd-f3a8-43fe-962d-b6222143c307\r\n[I 09:10:17.076 LabApp] Restoring connection for fc9693cd-f3a8-43fe-962d-b6222143c307:9325611663dd49f995fc3150124b5559\r\n[I 09:10:19.688 LabApp] Replaying 3 buffered messages\r\n[E 09:10:39.691 LabApp] Uncaught exception GET /api/kernels/fc9693cd-f3a8-43fe-962d-b6222143c307/channels?session_id=9325611663dd49f995fc3150124b5559 (127.0.0.1)\r\n    HTTPServerRequest(protocol='http', host='0.0.0.0:8888', method='GET', uri='/api/kernels/fc9693cd-f3a8-43fe-962d-b6222143c307/channels?session_id=9325611663dd49f995fc3150124b5559', version='HTTP/1.1', remote_ip='127.0.0.1')\r\n    Traceback (most recent call last):\r\n      File \"/opt/anaconda3/envs/notebook-dev/lib/python3.7/site-packages/tornado/websocket.py\", line 956, in _accept_connection\r\n        open_result = handler.open(*handler.open_args, **handler.open_kwargs)\r\n      File \"/Users/kbates/repos/oss/jupyter/notebook/notebook/services/kernels/handlers.py\", line 270, in open\r\n        self._on_zmq_reply(stream, msg_list)\r\n      File \"/Users/kbates/repos/oss/jupyter/notebook/notebook/services/kernels/handlers.py\", line 423, in _on_zmq_reply\r\n        super(ZMQChannelsHandler, self)._on_zmq_reply(stream, msg)\r\n      File \"/Users/kbates/repos/oss/jupyter/notebook/notebook/base/zmqhandlers.py\", line 242, in _on_zmq_reply\r\n        if self.ws_connection is None or stream.closed():\r\n    AttributeError: 'dict' object has no attribute 'closed'\r\n```\r\n\r\nI think the proper change is that [`stream = buffer_info['channels']`](https://github.com/jupyter/notebook/pull/5450/files#diff-5850e3e642720fc64de3044370632daeR269) should be:\r\n```python\r\n     stream = buffer_info['channels'][channel]\r\n```\r\nWhen that is done, restarts also work via Notebook when replays are active.  However, the kernel.js test still has failures, but of a different nature: https://travis-ci.org/github/kevin-bates/notebook/jobs/688097176  and I just don't know that particular test mechanics to determine if it's just an overzealous test or a real side-affecting issue.",
    "performed_via_github_app": null
  }
]
